{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/estimate.json",
  "title": "Estimate",
  "type": "object",
  "additionalProperties": false,
  "required": ["meta", "issuer", "client", "project", "sections", "totals", "notes"],
  "properties": {
    "meta": {
      "type": "object",
      "additionalProperties": false,
      "required": ["estimateId", "issuedDate", "validUntil"],
      "properties": {
        "estimateId": {
          "type": "string",
          "description": "見積書ID（社内採番）。例: 2026-000123"
        },
        "issuedDate": {
          "type": "string",
          "format": "date",
          "description": "発行日（YYYY-MM-DD）"
        },
        "validUntil": {
          "type": "string",
          "description": "有効期限（例: 発行日より3ヶ月 / YYYY-MM-DD）"
        },
        "currency": {
          "type": "string",
          "enum": ["JPY"],
          "default": "JPY"
        }
      }
    },
    "issuer": {
      "type": "object",
      "additionalProperties": false,
      "required": ["companyName", "department", "representative", "tel", "fax", "address"],
      "properties": {
        "companyName": { "type": "string" },
        "department": { "type": "string" },
        "representative": { "type": "string" },
        "tel": { "type": "string" },
        "fax": { "type": "string" },
        "address": {
          "type": "object",
          "additionalProperties": false,
          "required": ["postalCode", "prefecture", "city", "street"],
          "properties": {
            "postalCode": {
              "type": "string",
              "pattern": "^\\d{3}-\\d{4}$",
              "description": "例: 370-2606"
            },
            "prefecture": { "type": "string" },
            "city": { "type": "string" },
            "street": { "type": "string" }
          }
        }
      }
    },
    "client": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name"],
      "properties": {
        "name": { "type": "string", "description": "宛名（個人名/法人名）" },
        "honorific": {
          "type": "string",
          "enum": ["様", "御中"],
          "default": "様"
        }
      }
    },
    "project": {
      "type": "object",
      "additionalProperties": false,
      "required": ["title", "location"],
      "properties": {
        "title": { "type": "string", "description": "工事名称" },
        "location": { "type": "string", "description": "工事場所" }
      }
    },
    "sections": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/section" }
    },
    "totals": {
      "type": "object",
      "additionalProperties": false,
      "required": ["subTotalExclTax", "discountExclTax", "totalExclTax", "taxRate", "taxAmount", "totalInclTax"],
      "properties": {
        "subTotalExclTax": { "type": "integer", "minimum": 0, "description": "税抜小計（円）" },
        "discountExclTax": { "type": "integer", "maximum": 0, "description": "値引き（税抜、円、マイナス）" },
        "totalExclTax": { "type": "integer", "minimum": 0, "description": "差引税抜金額（円）" },
        "taxRate": { "type": "number", "minimum": 0, "maximum": 1, "description": "消費税率（例: 0.10）" },
        "taxAmount": { "type": "integer", "minimum": 0, "description": "消費税額（円）" },
        "totalInclTax": { "type": "integer", "minimum": 0, "description": "合計（税込、円）" }
      }
    },
    "notes": {
      "type": "object",
      "additionalProperties": false,
      "required": ["specialTerms"],
      "properties": {
        "specialTerms": {
          "type": "array",
          "minItems": 0,
          "items": { "type": "string" },
          "description": "備考・特記事項（箇条書き）"
        }
      }
    }
  },
  "$defs": {
    "section": {
      "type": "object",
      "additionalProperties": false,
      "required": ["code", "title", "items", "subTotalExclTax"],
      "properties": {
        "code": {
          "type": "string",
          "enum": ["1", "2", "3", "4"],
          "description": "セクション番号"
        },
        "title": { "type": "string" },
        "items": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/lineItem" }
        },
        "subTotalExclTax": {
          "type": "integer",
          "minimum": 0,
          "description": "セクション小計（税抜、円）"
        }
      }
    },
    "lineItem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "quantity", "unit", "unitPriceExclTax", "amountExclTax"],
      "properties": {
        "name": { "type": "string", "description": "工事名/摘要" },
        "quantity": { "type": "number", "minimum": 0 },
        "unit": { "type": "string", "description": "単位（坪, 式, m3, m2, 枚 など）" },
        "unitPriceExclTax": { "type": "integer", "minimum": 0, "description": "単価（税抜、円）" },
        "amountExclTax": { "type": "integer", "minimum": 0, "description": "金額（税抜、円）" },
        "remarks": { "type": "string" },
        "tags": {
          "type": "array",
          "items": { "type": "string" },
          "description": "分類タグ（任意）。例: 残置物/一般廃棄物/石綿L3"
        }
      }
    }
  }
}
